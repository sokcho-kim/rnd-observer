# 작업일지 2026-01-06

## 오늘 작업 내용

### Teams Workflow 연동 성공

**문제**: 회사 Teams에서 Incoming Webhook(커넥터)이 막혀있음

**해결**: Power Automate Workflow로 우회

#### 삽질 과정
1. Teams 앱 → 채널 → 워크플로 → "채널에 웹후크 알림 보내기" 템플릿 선택
2. 템플릿이 복잡한 구조로 생성됨 (조건문, For each 등)
3. 여러 에러 발생:
   - `teamId needs to be a valid GUID` → 팀/채널 설정 문제
   - `BotNotInConversationRoster` → Flow bot 권한 없음
   - `Property 'type' must be 'AdaptiveCard'` → Post card 액션은 Adaptive Card 필요
   - `foreach expression is of type 'Null'` → attachments 없을 때 For each 에러

4. **최종 해결**:
   - Power Automate 웹(make.powerautomate.com)에서 편집
   - 복잡한 조건문/For each 삭제
   - 단순 구조로 변경:
     ```
     [트리거] Teams 웹후크 요청이 수신된 경우
         ↓
     [액션] 채팅 또는 채널에서 메시지 게시
            - 다음으로 게시: 사용자 (흐름봇 X)
            - 팀: AI개발팀
            - 채널: Play Ground
            - 메시지: triggerBody()?['text']
     ```

#### 코드 수정
- `src/notifier/teams.py`: 응답코드 체크 `200` → `200, 202` 허용

#### 환경 설정
```
# .env
TEAMS_WEBHOOK_URL=https://default6cf28ed4b035426ebebc400a996655.27.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/3d718893556949f0b3f8a1f5ccc555a0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=...
```

#### 테스트 결과
- 단순 텍스트 `{"text": "rndo test!"}` → Play Ground 채널에 메시지 도착 확인!

### 주의사항 (삽질 방지)
1. **Incoming Webhook vs Workflow**: Office 365 커넥터는 2025년 12월 퇴역 예정, Workflow 사용 권장
2. **흐름봇 vs 사용자**: 비공개 채널이나 봇 권한 없으면 "사용자"로 게시
3. **Post card vs Post message**: Post card는 Adaptive Card 필수, 단순 텍스트는 Post message 사용
4. **For each 자동생성**: 동적 콘텐츠로 배열 넣으면 For each 자동생성됨, 수식(fx)으로 직접 입력하면 방지
5. **프리미엄 라이선스**: Power Automate 웹에서 "HTTP 요청 받은 경우" 트리거는 프리미엄 필요, Teams 앱 워크플로는 무료

---

### 스크래퍼 추가 구현

#### 1. NTIS 스크래퍼 (성공)
- **URL**: https://www.ntis.go.kr/rndgate/eg/un/ra/mng.do
- **파일**: `src/scrapers/ntis.py`
- **특징**:
  - 국가R&D 통합공고 페이지
  - 로그인 없이 접근 가능
  - 75,755건 공고 (전체)
  - 연도 필터링 지원 (`year` 파라미터)
- **테스트 결과**: 2026년 공고 6건 수집 성공

#### 2. IRIS 스크래퍼 (실패)
- **URL**: https://www.iris.go.kr
- **파일**: `src/scrapers/iris.py`
- **문제**: **로그인 필요** - 과제공고 열람 시 회원인증 요구
- **상태**: 보류

#### 3. 나라장터(G2B) 스크래퍼 (실패)
- **URL**: https://www.g2b.go.kr
- **파일**: `src/scrapers/g2b.py`
- **문제**: 8101 포트 접속 타임아웃/보안 차단
- **대안**:
  - g2bplus.kr (나라장터 데이터 기반 검색)
  - 공공데이터포털 API
- **상태**: 대안 검토 필요

#### 4. 기업마당 스크래퍼 (성공)
- **URL**: https://www.bizinfo.go.kr/web/lay1/bbs/S1T122C128/AS/74/list.do
- **파일**: `src/scrapers/bizinfo.py`
- **특징**:
  - 중소벤처기업부·지자체·부처 전체의 공모·사업 공고 통합
  - 테이블 형식 (번호, 지원분야, 지원사업명, 신청기간, 소관부처 등)
  - 연도 필터링 + 페이지네이션 지원
- **테스트 결과**: 2026년 공고 24건 수집 성공

#### 5. K-Startup 스크래퍼 (성공)
- **URL**: https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do
- **파일**: `src/scrapers/kstartup.py`
- **특징**:
  - 창업·초기기업 대상 R&D/실증 과제
  - 리스트 형식 + Lazy Loading
  - D-day 표시로 마감일 계산
- **테스트 결과**: 2026년 공고 10건 수집 성공

### 스크래퍼 현황 요약

| 스크래퍼 | 파일 | 상태 | 수집 건수 |
|----------|------|------|-----------|
| aifactory | `aifactory.py` | ✅ 성공 | 109건 |
| NTIS | `ntis.py` | ✅ 성공 | 6건 (2026년) |
| 기업마당 | `bizinfo.py` | ✅ 성공 | 24건 (2026년) |
| K-Startup | `kstartup.py` | ✅ 성공 | 10건 (2026년) |
| IRIS | `iris.py` | ❌ 로그인 필요 | - |
| 나라장터 | `g2b.py` | ❌ 접속 불가 | - |

### 프로젝트 구조 (업데이트)

```
rnd-observer/
├── src/
│   ├── main.py
│   ├── models/
│   │   └── announcement.py
│   ├── scrapers/
│   │   ├── base.py
│   │   ├── aifactory.py    # ✅ 공모전
│   │   ├── ntis.py         # ✅ 국가R&D
│   │   ├── bizinfo.py      # ✅ 기업마당
│   │   ├── kstartup.py     # ✅ K-Startup
│   │   ├── iris.py         # ❌ 로그인필요
│   │   └── g2b.py          # ❌ 접속불가
│   └── notifier/
│       └── teams.py        # ✅ 워크플로 연동
├── data/
│   ├── aifactory/screenshots/
│   ├── ntis/screenshots/
│   ├── bizinfo/screenshots/
│   ├── kstartup/screenshots/
│   └── ...
├── logs/
│   ├── 2026-01-05.md
│   └── 2026-01-06.md
├── plan/
│   └── source_cites.md     # 소스 참고문서
├── .env
└── requirements.txt
```

---

## 다음 작업

1. **새 공고 감지 로직 구현**
   - 기존 수집 데이터 저장 (JSON/DB)
   - 신규 공고만 필터링

2. **E2E 연동 테스트**
   - 스크래핑 → 새 공고 감지 → Teams 알림

3. **마크다운 포맷팅**
   - Adaptive Card 대신 마크다운으로 공고 정보 포맷팅
   - 예: `**제목**: ...\n**기관**: ...\n**마감**: ...`

4. **배치 스케줄러 설정**
   - Azure Functions Timer Trigger (매일 9시, 18시)
   - 또는 Windows Task Scheduler / cron

5. **추가 소스 (추후)**
   - 공모전 포털: 올콘, 위비티, 스펙토리
   - 나라장터 대안: g2bplus.kr 또는 공공데이터 API

## 참고 링크

| 사이트 | URL |
|--------|-----|
| Power Automate | https://make.powerautomate.com |
| NTIS | https://www.ntis.go.kr |
| 기업마당 | https://www.bizinfo.go.kr |
| K-Startup | https://www.k-startup.go.kr |
| aifactory | https://aifactory.space |

## 작업 요약

**오늘 완료:**
- ✅ Teams 워크플로 연동 (삽질 끝에 성공)
- ✅ NTIS 스크래퍼 구현
- ✅ 기업마당 스크래퍼 구현
- ✅ K-Startup 스크래퍼 구현
- ✅ 문서화

**보류:**
- ❌ IRIS (로그인 필요)
- ❌ 나라장터 (접속 불가)
- ⏳ E2E 연동 테스트
- ⏳ 배치 스케줄러
